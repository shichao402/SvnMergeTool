# 用户自定义节点指引

## 概述

用户自定义节点允许你扩展流程图的功能，无需修改源代码。节点定义使用 JSON 格式，存放在 `~/.svn_flow/nodes/` 目录下。

## 快速开始

### 1. 创建节点目录

```bash
mkdir -p ~/.svn_flow/nodes
```

### 2. 创建节点定义文件

文件命名规则：`{typeId}.node.json`

### 3. 重启应用或调用加载方法

```dart
await UserNodeLoader.loadAndRegisterUserNodes();
```

---

## 节点定义结构

```json
{
  "typeId": "my_node",           // 唯一标识（必填）
  "name": "我的节点",             // 显示名称（必填）
  "description": "节点描述",      // 描述（可选）
  "icon": "terminal",            // 图标名称（可选）
  "color": "blue",               // 颜色（可选）
  "category": "自定义",           // 分类（可选）
  "inputs": [...],               // 输入端口（可选）
  "outputs": [...],              // 输出端口（可选）
  "params": [...],               // 可配置参数（可选）
  "executor": {...}              // 执行器配置（必填）
}
```

---

## 端口定义

### 输入端口 (inputs)

```json
{
  "id": "in",                    // 端口 ID
  "name": "输入",                 // 显示名称
  "description": "接收上游数据"    // 描述（可选）
}
```

### 输出端口 (outputs)

```json
{
  "id": "success",               // 端口 ID
  "name": "成功",                 // 显示名称
  "description": "执行成功时触发"  // 描述（可选）
}
```

**常用端口约定：**
- `in` - 标准输入
- `success` - 成功输出
- `failure` - 失败输出
- `timeout` - 超时输出（轮询节点）

---

## 参数定义 (params)

```json
{
  "key": "timeout",              // 参数键名
  "name": "超时时间",             // 显示名称
  "type": "int",                 // 类型: string, int, double, bool, select
  "defaultValue": 300,           // 默认值
  "description": "命令超时秒数",   // 描述（可选）
  "required": false,             // 是否必填
  "options": ["opt1", "opt2"]    // select 类型的选项
}
```

---

## 执行器类型

### 1. Shell 执行器

执行 Shell 命令。

```json
{
  "executor": {
    "type": "shell",
    "command": "svn info ${job.targetWc}",
    "workDir": "${job.targetWc}",
    "timeout": 300,
    "outputParser": {
      "revision": "regex:Revision: (\\d+)"
    },
    "portMapping": {
      "exitCode": {
        "0": "success",
        "*": "failure"
      }
    }
  }
}
```

### 2. HTTP 执行器

发送 HTTP 请求。

```json
{
  "executor": {
    "type": "http",
    "url": "https://api.example.com/status",
    "method": "GET",
    "headers": {
      "Authorization": "Bearer ${config.token}"
    },
    "timeout": 30,
    "portMapping": {
      "statusCode": {
        "200-299": "success",
        "*": "failure"
      }
    }
  }
}
```

### 3. Poll 执行器

轮询执行命令直到条件满足。

```json
{
  "executor": {
    "type": "poll",
    "command": "curl -s http://localhost:8080/health",
    "interval": 30,
    "timeout": 60,
    "conditions": {
      "success": "contains:healthy",
      "failure": "contains:error"
    },
    "onTimeout": "timeout"
  }
}
```

---

## 变量替换

在命令和配置中可使用以下变量：

| 变量格式 | 说明 | 示例 |
|---------|------|------|
| `${input.xxx}` | 上游节点传入的数据 | `${input.revision}` |
| `${config.xxx}` | 节点配置参数 | `${config.timeout}` |
| `${params.xxx}` | 同 config | `${params.branch}` |
| `${var.xxx}` | 上下文变量 | `${var.buildId}` |
| `${job.xxx}` | 任务信息 | `${job.sourceUrl}` |

### Job 可用字段

- `${job.jobId}` - 任务 ID
- `${job.sourceUrl}` - 源 URL
- `${job.targetWc}` - 目标工作副本路径
- `${job.currentRevision}` - 当前版本号
- `${job.revisions}` - 所有版本号（逗号分隔）
- `${job.completedIndex}` - 已完成索引

---

## 条件表达式

用于 `portMapping` 和 `conditions`：

| 表达式 | 说明 |
|--------|------|
| `contains:xxx` | 输出包含 xxx |
| `regex:pattern` | 正则匹配 |
| `equals:xxx` | 完全等于 xxx |
| `exitCode == 0` | 退出码比较 |
| `*` | 通配符（总是匹配） |

---

## 图标列表

可用图标名称：

`play_arrow`, `stop`, `pause`, `refresh`, `build`, `code`, `terminal`, `input`, `output`, `upload`, `download`, `merge`, `commit`, `check`, `close`, `error`, `warning`, `info`, `help`, `settings`, `folder`, `file`, `http`, `api`, `cloud`, `sync`, `timer`, `schedule`, `hourglass_empty`, `hourglass_full`, `create_new_folder`, `cleaning_services`, `extension`

---

## 颜色列表

可用颜色名称：

`red`, `pink`, `purple`, `deepPurple`, `indigo`, `blue`, `lightBlue`, `cyan`, `teal`, `green`, `lightGreen`, `lime`, `yellow`, `amber`, `orange`, `deepOrange`, `brown`, `grey`, `blueGrey`

或使用十六进制：`#FF5722`, `#4CAF50`

---

## 完整示例

### 示例 1：Git 状态检查节点

```json
{
  "typeId": "git_status",
  "name": "Git 状态",
  "description": "检查 Git 仓库状态",
  "icon": "code",
  "color": "orange",
  "category": "Git 操作",
  "inputs": [
    {"id": "in", "name": "输入"}
  ],
  "outputs": [
    {"id": "clean", "name": "干净"},
    {"id": "dirty", "name": "有修改"},
    {"id": "failure", "name": "失败"}
  ],
  "params": [
    {
      "key": "repoPath",
      "name": "仓库路径",
      "type": "string",
      "defaultValue": "",
      "description": "Git 仓库路径，留空使用工作副本路径"
    }
  ],
  "executor": {
    "type": "shell",
    "command": "git status --porcelain",
    "workDir": "${config.repoPath}",
    "timeout": 30,
    "portMapping": {
      "exitCode": {
        "0": "clean",
        "*": "failure"
      },
      "stdout": {
        "*": "dirty"
      }
    }
  }
}
```

### 示例 2：等待构建完成节点

```json
{
  "typeId": "wait_build",
  "name": "等待构建",
  "description": "轮询等待 CI 构建完成",
  "icon": "hourglass_empty",
  "color": "amber",
  "category": "CI/CD",
  "inputs": [
    {"id": "in", "name": "输入"}
  ],
  "outputs": [
    {"id": "success", "name": "构建成功"},
    {"id": "failure", "name": "构建失败"},
    {"id": "timeout", "name": "超时"}
  ],
  "params": [
    {
      "key": "buildUrl",
      "name": "构建 URL",
      "type": "string",
      "required": true,
      "description": "CI 构建状态 API URL"
    },
    {
      "key": "interval",
      "name": "轮询间隔(秒)",
      "type": "int",
      "defaultValue": 30
    },
    {
      "key": "timeout",
      "name": "超时时间(分钟)",
      "type": "int",
      "defaultValue": 30
    }
  ],
  "executor": {
    "type": "poll",
    "command": "curl -s ${config.buildUrl}",
    "interval": "${config.interval}",
    "timeout": "${config.timeout}",
    "conditions": {
      "success": "contains:\"status\":\"success\"",
      "failure": "contains:\"status\":\"failed\""
    },
    "onTimeout": "timeout"
  }
}
```

---

## 代码方式创建节点

除了 JSON 文件，也可以在代码中直接创建：

```dart
import 'package:flutter/material.dart';
import 'package:SvnMergeTool/pipeline/registry/registry.dart';
import 'package:SvnMergeTool/pipeline/engine/new_engine.dart';

// 1. 定义执行器函数
Future<NodeOutput> myExecutor({
  required Map<String, dynamic> input,
  required Map<String, dynamic> config,
  required ExecutionContext context,
}) async {
  context.info('开始执行自定义逻辑...');
  
  try {
    // 你的业务逻辑
    final result = await doSomething(config['param1']);
    
    return NodeOutput.success(
      data: {'result': result},
      message: '执行成功',
    );
  } catch (e) {
    context.error('执行失败: $e');
    return NodeOutput.failure(message: e.toString());
  }
}

// 2. 创建节点定义
final myNodeDefinition = NodeTypeDefinition(
  typeId: 'my_custom_node',
  name: '我的自定义节点',
  description: '这是一个自定义节点示例',
  icon: Icons.extension,
  color: Colors.purple,
  category: '自定义',
  inputs: const [PortSpec.defaultInput],
  outputs: const [PortSpec.success, PortSpec.failure],
  params: const [
    ParamSpec(
      key: 'param1',
      name: '参数1',
      type: ParamType.string,
      defaultValue: 'default',
      description: '这是参数1的描述',
    ),
  ],
  executor: myExecutor,
);

// 3. 注册节点
void registerMyNode() {
  NodeTypeRegistry.instance.register(myNodeDefinition);
}
```

---

## 调试技巧

1. **查看日志**：执行器中使用 `context.info()`, `context.debug()`, `context.error()` 输出日志

2. **测试命令**：先在终端测试 shell 命令，确保正确后再配置到节点

3. **检查变量**：在命令中加入 `echo` 输出变量值进行调试

4. **验证 JSON**：使用 JSON 验证工具检查配置文件格式
